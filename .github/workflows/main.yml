name: Build Windows (PyInstaller)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_DIR: virtual_controller
  APP_NAME: VirtualController
  PYTHON_VERSION: "3.12"

jobs:
  build-windows:
    # Сборка именно на твоем Windows сервере (self-hosted runner).
    # Убедись, что у runner есть labels: self-hosted, windows, x64 (или поправь под свои).
    runs-on: [self-hosted, windows, x64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            ${{ env.APP_DIR }}/requirements.txt

      - name: Install dependencies
        shell: powershell
        working-directory: ${{ env.APP_DIR }}
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build (PyInstaller one-dir)
        shell: powershell
        working-directory: ${{ env.APP_DIR }}
        run: |
          # Важно: one-dir по умолчанию — это папка dist\<APP_NAME>\ с .exe и всеми DLL/py-файлами.
          pyinstaller `
            --noconfirm `
            --clean `
            --windowed `
            --name "${env:APP_NAME}" `
            main.py

          # Если выяснится, что какие-то модули подтягиваются динамически и не попали в сборку,
          # добавишь сюда hidden-import/collect, например:
          # --hidden-import serial.tools.list_ports
          # --collect-all serial

      - name: Package artifact (zip)
        shell: powershell
        working-directory: ${{ env.APP_DIR }}
        run: |
          $zipName = "${env:APP_NAME}-windows-x64.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }

          $distPath = Join-Path "dist" $env:APP_NAME
          if (!(Test-Path $distPath)) { throw "Build output not found: $distPath" }

          Compress-Archive -Path (Join-Path $distPath '*') -DestinationPath $zipName
          Write-Host "Created artifact: $zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-x64
          path: ${{ env.APP_DIR }}/${{ env.APP_NAME }}-windows-x64.zip
          if-no-files-found: error
